<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panaderia La Nube</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .producto-img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      background: #ccc;
      border-radius: 8px;
      display: block;
    }
    .producto-card {
      margin-bottom: 20px;
    }
    #carrito-indicador {
      position: fixed;
      top: 20px;
      right: 30px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="carrito-indicador" class="alert alert-info py-2 px-3">
    Carrito: <span id="carrito-cantidad">0</span> productos
  </div>
  <div class="container">
    <h1 class="my-4">Nuestros productos:</h1>
    <div id="contenedor" class="row">
      <!-- Los datos se cargarán aquí -->
    </div>
    <div class="text-end my-4">
    <button id="ver-carrito" class="btn btn-success">Ver carrito</button>
  </div>
  </div>

 <script>
    // El carrito ahora es un array de objetos: {id, nombre, precio, foto, cantidad}
    const carrito = [];

    function actualizarCarrito() {
      // Suma total de unidades
      const totalUnidades = carrito.reduce((acc, prod) => acc + prod.cantidad, 0);
      document.getElementById('carrito-cantidad').textContent = totalUnidades;
    }

    async function cargarDatos() {
      const contenedor = document.getElementById('contenedor');
      contenedor.innerHTML = `
        <div class="text-center my-5">
          <div class="spinner-border" role="status"></div>
          <span class="ms-2">Cargando...</span>
        </div>
      `;

      try {
        const respuesta = await fetch('/api/productos');
        const datos = await respuesta.json();

        contenedor.innerHTML = "";
        datos.forEach((item, index) => {
          const imgSrc = item.foto ? item.foto : "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='200' height='200' fill='%23cccccc'/></svg>";
          const nombre = item.nombre || "Producto sin nombre";
          const precio = item.precio ? `$${item.precio}` : "";

          const card = document.createElement('div');
          card.className = "col-12 col-sm-6 col-md-4 col-lg-3 producto-card";
          card.innerHTML = `
            <div class="card h-100">
              <img src="${imgSrc}" alt="${nombre}" class="producto-img card-img-top">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${nombre}</h5>
                <p class="card-text">${precio}</p>
                <button class="btn btn-primary mt-auto agregar-btn">Agregar</button>
              </div>
            </div>
          `;
          // Agregar evento al botón
          card.querySelector('.agregar-btn').addEventListener('click', () => {
            // Busca si el producto ya está en el carrito
            const existente = carrito.find(prod => prod.id === item.id);
            if (existente) {
              existente.cantidad += 1;
            } else {
              carrito.push({
                id: item.id,
                nombre: item.nombre,
                precio: item.precio,
                foto: item.foto,
                cantidad: 1
              });
            }
            actualizarCarrito();
          });
          contenedor.appendChild(card);
        });
      } catch (error) {
        contenedor.innerHTML = "<div class='alert alert-danger'>Error al cargar los datos.</div>";
        console.error(error);
      }
    }

    document.getElementById('ver-carrito').addEventListener('click', () => {
      if (carrito.length > 0) {
        fetch('/carrito', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(carrito)
        }).then(() => {
          window.location.href = '/carrito';
        });
      } else {
        alert("El carrito está vacío.");
      }
    });

    cargarDatos();
    actualizarCarrito();
  </script>
</body>
</html>